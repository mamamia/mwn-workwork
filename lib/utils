#!/bin/bash

# Utility functions
type_exists() {
  if [ $(type -P $1) ]; then
    return 0
  fi
  return 1
}

# Compares git hashes
check_version() {
  cd $WW_DIR && git fetch --quiet
  # Version
  VER_LOCAL=$(git rev-parse @{0})
  VER_REMOTE=$(git rev-parse @{u})
  VER_BASE=$(git merge-base @{0} @{u})
  if [ $VER_LOCAL = $VER_REMOTE ]; then
    :
  elif [ $VER_LOCAL = $VER_BASE ]; then
    display_status_primary "INFO" "Updating WorkWork..."
    cd $WW_DIR && git pull --quiet origin master
    # Start the command over with the updated files
    exec "$0" "$1" "$2"
  elif [ $VER_REMOTE = $VER_BASE ]; then
    display_status_primary "WARN" "Please push your changes to the remote..."
  else
    display_status_primary "ERROR" "Can't update WorkWork due to local changes..."
  fi
}

# Grabs sudo and tries to keep it alive
# Credit: https://gist.github.com/cowboy/3118588
check_sudo() {
  sudo -v -p 'Enter your sudo password:'
  while true; do sudo -n true; sleep 40; kill -0 "$$" || exit; done 2>/dev/null &
}

# Ensure at least one command is supplied
check_command() {
  if [ $1 -lt 1 ]; then
    $0 "--help"
  fi
}

install_app() {
  if [ $PLATFORM == "osx" ]; then
    brew update
    brew install $1
  elif [ $PLATFORM == "linux" ]; then
    # Assumes Ubuntu/Debian for now
    sudo apt-get update
    sudo apt-get install $1 < /dev/null
  fi
}

setup_site() {
  if [ $1 = "dd" ]; then
    SITE_FULL_NAME="Debrief Daily"
    SITE_NAME="debriefdaily"
    SITE_DIR="${HOME}/workspace/mwn-${SITE_NAME}"
    SITE_PROD_URL="www.${SITE_NAME}.com"
  # elif [ $1 = "mm" ]; then
  #   # Etc
  fi
}

# Detect shell
# http://stackoverflow.com/questions/9910966/how-to-tell-if-its-using-zsh-or-bash
check_shell() {
  if [ -n "`$SHELL -c 'echo $ZSH_VERSION'`" ]; then
    DETECTED_SHELL="zsh"
    PROFILE="${HOME}/.zshrc"
  elif [ -n "`$SHELL -c 'echo $BASH_VERSION'`" ]; then
    DETECTED_SHELL="bash"
    PROFILE="${HOME}/.bashrc"
  else
    echo "FATAL: Could not detect the shell!"
    exit
  fi
}

# Detect the platform via uname
# http://stackoverflow.com/a/17072017
# https://raw.githubusercontent.com/yellowducklabs/duckos/master/duck
check_platform() {
  if [[ "$UNAME" == 'Darwin' ]]; then
    PLATFORM="osx"
  elif [[ "$UNAME" == 'Linux' ]]; then
    PLATFORM="linux"
  elif [[ "$UNAME" == 'MINGW32_NT' ]]; then
    echo "FATAL: This script is not Windows compatible!"
    exit
  else
    echo "FATAL: Could not detect the platform!"
    exit
  fi
}

# Save cursor
save_cursor() {
  tput sc
}

# Restore cursor and erase to end of line
replace_line() {
  tput rc
  tput el
}
